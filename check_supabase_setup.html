<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase è®¾ç½®æ£€æŸ¥å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .check-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
        }
        .check-item h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.pending {
            background: #ffc107;
            color: #000;
        }
        .status.success {
            background: #28a745;
            color: white;
        }
        .status.error {
            background: #dc3545;
            color: white;
        }
        .details {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            font-size: 13px;
            color: #666;
            display: none;
        }
        .details.show {
            display: block;
        }
        .details pre {
            background: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin-top: 5px;
            font-size: 12px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s;
        }
        button:hover {
            background: #5568d3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .summary {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            text-align: center;
        }
        .summary h2 {
            color: #333;
            margin-bottom: 10px;
        }
        .summary .count {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Supabase è®¾ç½®æ£€æŸ¥å·¥å…·</h1>
        <p class="subtitle">æ£€æŸ¥æ•°æ®åº“è¡¨ã€RLS ç­–ç•¥å’Œè¿æ¥çŠ¶æ€</p>
        
        <div id="checks">
            <div class="check-item">
                <h3>1. Supabase è¿æ¥ <span class="status pending" id="status-connection">æ£€æŸ¥ä¸­...</span></h3>
                <div class="details" id="details-connection"></div>
            </div>
            
            <div class="check-item">
                <h3>2. users è¡¨ <span class="status pending" id="status-users">ç­‰å¾…ä¸­...</span></h3>
                <div class="details" id="details-users"></div>
            </div>
            
            <div class="check-item">
                <h3>3. friend_requests è¡¨ <span class="status pending" id="status-requests">ç­‰å¾…ä¸­...</span></h3>
                <div class="details" id="details-requests"></div>
            </div>
            
            <div class="check-item">
                <h3>4. friends è¡¨ <span class="status pending" id="status-friends">ç­‰å¾…ä¸­...</span></h3>
                <div class="details" id="details-friends"></div>
            </div>
            
            <div class="check-item">
                <h3>5. RLS ç­–ç•¥æ£€æŸ¥ <span class="status pending" id="status-rls">ç­‰å¾…ä¸­...</span></h3>
                <div class="details" id="details-rls"></div>
            </div>
            
            <div class="check-item">
                <h3>6. ç”¨æˆ·æœç´¢åŠŸèƒ½æµ‹è¯• <span class="status pending" id="status-search">ç­‰å¾…ä¸­...</span></h3>
                <div class="details" id="details-search"></div>
            </div>
        </div>
        
        <button id="checkBtn" onclick="runAllChecks()">å¼€å§‹æ£€æŸ¥</button>
        
        <div class="summary" id="summary" style="display: none;">
            <h2>æ£€æŸ¥ç»“æœ</h2>
            <div class="count" id="successCount">0</div>
            <p>é¡¹æ£€æŸ¥é€šè¿‡</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_CONFIG = window.MOOD_PLAYER_SUPABASE || {
            url: "https://nlavqjsztdfxksjusyky.supabase.co",
            anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sYXZxanN6dGRmeGtzanVzeWt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNzU1MDcsImV4cCI6MjA4NTc1MTUwN30.moPoq8daEdww89UYhYX0JJA8XpwT1CqKPXxJq8k7b54"
        };

        let supabase = null;
        let successCount = 0;

        function updateStatus(id, status, message = '') {
            const statusEl = document.getElementById(`status-${id}`);
            const detailsEl = document.getElementById(`details-${id}`);
            
            statusEl.className = `status ${status}`;
            
            if (status === 'pending') {
                statusEl.textContent = 'æ£€æŸ¥ä¸­...';
            } else if (status === 'success') {
                statusEl.textContent = 'âœ“ é€šè¿‡';
                successCount++;
            } else {
                statusEl.textContent = 'âœ— å¤±è´¥';
            }
            
            if (message) {
                detailsEl.innerHTML = message;
                detailsEl.classList.add('show');
            }
        }

        async function checkConnection() {
            try {
                supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                updateStatus('connection', 'success', 'âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
                return true;
            } catch (error) {
                updateStatus('connection', 'error', `âŒ è¿æ¥å¤±è´¥: ${error.message}`);
                return false;
            }
        }

        async function checkTable(tableName) {
            try {
                const { data, error } = await supabase
                    .from(tableName)
                    .select('*')
                    .limit(1);
                
                if (error) {
                    if (error.code === '42P01') {
                        updateStatus(tableName, 'error', `âŒ è¡¨ "${tableName}" ä¸å­˜åœ¨<br><small>è¯·åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ friends-setup.sql</small>`);
                    } else if (error.code === '42501') {
                        updateStatus(tableName, 'error', `âŒ RLS ç­–ç•¥é—®é¢˜: ${error.message}<br><small>è¯·æ£€æŸ¥ RLS ç­–ç•¥è®¾ç½®</small>`);
                    } else {
                        updateStatus(tableName, 'error', `âŒ é”™è¯¯: ${error.message}`);
                    }
                    return false;
                }
                
                updateStatus(tableName, 'success', `âœ… è¡¨ "${tableName}" å­˜åœ¨ä¸”å¯è®¿é—®`);
                return true;
            } catch (error) {
                updateStatus(tableName, 'error', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`);
                return false;
            }
        }

        async function checkRLS() {
            try {
                // å°è¯•æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ï¼ˆéœ€è¦ "Users can view all users" ç­–ç•¥ï¼‰
                const { data, error } = await supabase
                    .from('users')
                    .select('id, email, name')
                    .limit(5);
                
                if (error) {
                    if (error.code === '42501') {
                        updateStatus('rls', 'error', `âŒ RLS ç­–ç•¥ç¼ºå¤±æˆ–é…ç½®é”™è¯¯<br><small>é”™è¯¯: ${error.message}</small><br><small>è¯·æ‰§è¡Œ fix-rls-policy.sql ä¸­çš„ SQL</small>`);
                    } else {
                        updateStatus('rls', 'error', `âŒ RLS æ£€æŸ¥å¤±è´¥: ${error.message}`);
                    }
                    return false;
                }
                
                updateStatus('rls', 'success', `âœ… RLS ç­–ç•¥é…ç½®æ­£ç¡®<br><small>å¯ä»¥æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ï¼ˆç”¨äºæœç´¢åŠŸèƒ½ï¼‰</small>`);
                return true;
            } catch (error) {
                updateStatus('rls', 'error', `âŒ RLS æ£€æŸ¥å¼‚å¸¸: ${error.message}`);
                return false;
            }
        }

        async function checkSearch() {
            try {
                // æµ‹è¯•æœç´¢åŠŸèƒ½
                const { data, error } = await supabase
                    .from('users')
                    .select('id, email, name')
                    .ilike('email', '%@%')
                    .limit(5);
                
                if (error) {
                    updateStatus('search', 'error', `âŒ æœç´¢åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`);
                    return false;
                }
                
                const count = data ? data.length : 0;
                updateStatus('search', 'success', `âœ… æœç´¢åŠŸèƒ½æ­£å¸¸<br><small>æ‰¾åˆ° ${count} ä¸ªç”¨æˆ·ï¼ˆæµ‹è¯•æŸ¥è¯¢ï¼‰</small>`);
                return true;
            } catch (error) {
                updateStatus('search', 'error', `âŒ æœç´¢æµ‹è¯•å¼‚å¸¸: ${error.message}`);
                return false;
            }
        }

        async function runAllChecks() {
            const btn = document.getElementById('checkBtn');
            btn.disabled = true;
            btn.textContent = 'æ£€æŸ¥ä¸­...';
            successCount = 0;
            
            // 1. æ£€æŸ¥è¿æ¥
            const connected = await checkConnection();
            if (!connected) {
                btn.disabled = false;
                btn.textContent = 'é‡æ–°æ£€æŸ¥';
                return;
            }
            
            // 2. æ£€æŸ¥è¡¨
            await checkTable('users');
            await checkTable('friend_requests');
            await checkTable('friends');
            
            // 3. æ£€æŸ¥ RLS
            await checkRLS();
            
            // 4. æ£€æŸ¥æœç´¢åŠŸèƒ½
            await checkSearch();
            
            // æ˜¾ç¤ºæ€»ç»“
            document.getElementById('summary').style.display = 'block';
            document.getElementById('successCount').textContent = successCount;
            
            btn.disabled = false;
            btn.textContent = 'é‡æ–°æ£€æŸ¥';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            setTimeout(runAllChecks, 500);
        });
    </script>
</body>
</html>
